<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">

    <link rel="stylesheet" href="../css/example.css">
 
    <script src="../js/message.js"></script>
    <!-- 添加字体图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    
</head>
<body>
    

    <div class="example-container">
        <!-- 按钮组 -->
        <div class="action-bar">
            <button class="btn blue" onclick="showCollectDialog()">
                链接采集
            </button>
            <button class="btn green" onclick="showAddDialog()">
                添加链接
            </button>
            <button class="btn red" onclick="batchDelete()">
                批量删除
            </button>
            <button class="btn cyan" onclick="refreshList()">
                刷新
            </button>
        </div>

        <!-- 搜索栏 -->
        <div class="search-bar">
            <div class="search-input">
                <input type="text" id="searchInput" placeholder="搜索标题或链接...">
                <button class="search-btn" onclick="search()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>

        <!-- 表格 -->
        <div class="table-container">
            <table id="itemTable" class="item-table">
            <thead>
                <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)">
                        </th>
                    <th>标题</th>
                    <th>链接</th>
                    <th>作者</th>
                    <th>创建时间</th>
                    <th>修改时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="itemList"></tbody>
        </table>
        </div>

        <!-- 分页 -->
        <div class="pagination">
            <div class="pagination-container">
                <div class="pagination-info">
                    共 <span id="totalCount">0</span> 项
                </div>
                <div class="page-size">
                    每页显示：
                    <select id="pageSize" onchange="changePageSize()">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div class="page-list">
                    <button class="page-btn" onclick="prevPage()"><i class="fas fa-chevron-left"></i></button>
                    <div class="page-numbers" id="pageNumbers">
                        <span class="current">1</span>
                        <span>2</span>
                        <span>3</span>
                    </div>
                    <button class="page-btn" onclick="nextPage()"><i class="fas fa-chevron-right"></i></button>
                    <div class="page-jump">
                        <input type="text" id="pageInput" value="1">
                        <span>页</span>
                        <button class="btn" onclick="jumpToPage()">跳转</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    
    <!-- 添加项目弹窗 -->
    <div id="addDialog" class="modal">
        <div class="modal-content">
            <h3>添加链接</h3>
            <div class="form-group">
                <label>链接：</label>
                <input type="text" id="link" placeholder="请输入链接">
            </div>
            <div class="form-group">
                <label>标题：</label>
                <input type="text" id="title" placeholder="请输入标题">
            </div>
            <div class="button-group">
                <button class="btn gray" onclick="hideAddDialog()">取消</button>
                <button class="btn blue" onclick="addItem()">确定</button>
            </div>
        </div>
    </div>

    <!-- 编辑项目弹窗 -->
    <div id="editDialog" class="modal">
        <div class="modal-content">
            <h3>编辑链接</h3>
            <div class="form-group">
                <label>链接：</label>
                <input type="text" id="editLink" placeholder="请输入链接">
            </div>
            <div class="form-group">
                <label>标题：</label>
                <input type="text" id="editTitle" placeholder="请输入标题">
            </div>
            <div class="form-group">
                <label>作者：</label>
                <input type="text" id="editAuthor" placeholder="请输入作者">
            </div>
            <input type="hidden" id="editId">
            <div class="button-group">
                <button class="btn gray" onclick="hideEditDialog()">取消</button>
                <button class="btn blue" onclick="updateItem()">确定</button>
            </div>
        </div>
    </div>

    <!-- 添加链接采集弹窗 -->
    <div id="collectDialog" class="modal">
        <div class="modal-content">
            <h3>链接采集</h3>
            <div class="form-group">
                <label>关键词：</label>
                <input type="text" id="keyword" placeholder="请输入关键词">
            </div>
            <div class="form-group">
                <label>采集账号：</label>
                <select id="collectAccount">
                    <option value="">请选择采集账号</option>
                </select>
            </div>
            <div class="button-group">
                <button class="btn gray" onclick="hideCollectDialog()">取消</button>
                <button class="btn blue" onclick="collectLinks()">确定</button>
            </div>
        </div>
    </div>



    <script>

         //从url获取参数
         const urlParams = new URLSearchParams(window.location.search);
         const pluginName = urlParams.get('pluginName');
         const version = urlParams.get('version');
         console.log("pluginName===============" + pluginName);
         console.log("version===============" + version);



         // 显示添加弹窗
        function showAddDialog() {
            document.getElementById('addDialog').style.display = 'block';
        }
        // 隐藏添加弹窗
        function hideAddDialog() {
            document.getElementById('addDialog').style.display = 'none';
            document.getElementById('title').value = '';
            document.getElementById('link').value = '';
        }

        // 分页相关变量
        let currentPage = 1;
        let pageSize = 10;
        let keyword = '';

        // 加载数据的函数
        async function loadItems(page = 1, newKeyword = null, newPageSize = null) {
            // 添加表格加载状态
            const itemList = document.getElementById('itemList');
            itemList.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;">加载中...</td></tr>';

            try {
                // 更新搜索和分页参数
                currentPage = page;
                if (newKeyword !== null) keyword = newKeyword;
                if (newPageSize !== null) pageSize = newPageSize;
                
                const api = window.parent.parent.pywebview.api.plugin;
                if (!api) {
                    console.error('API 未初始化');
                    return;
                }

                const result = await api.handle_api_call({
                    plugin_name: pluginName,
                    version: version,
                    controller_name: 'example_controller',
                    method_name: 'get_items',
                    page: currentPage,
                    page_size: pageSize,
                    keyword: keyword
                });

                if (result && result.success && result.data) {
                    renderTable(result.data.items || []);
                    renderPagination(result.data);
                } else {
                    document.getElementById('itemList').innerHTML = '<tr><td colspan="7" style="text-align:center;color:red;padding:20px;">加载失败</td></tr>';
                    // 重置分页显示
                    document.getElementById('totalCount').textContent = '0';
                    document.getElementById('pageNumbers').innerHTML = '';
                }
            } catch (e) {
                console.error('加载失败:', e);
                document.getElementById('itemList').innerHTML = '<tr><td colspan="7" style="text-align:center;color:red;padding:20px;">加载失败</td></tr>';
                // 重置分页显示
                document.getElementById('totalCount').textContent = '0';
                document.getElementById('pageNumbers').innerHTML = '';
            }
        }

        // 渲染表格数据
        function renderTable(items) {
            const itemList = document.getElementById('itemList');
            itemList.innerHTML = '';
            
            if (!Array.isArray(items) || items.length === 0) {
                itemList.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#888;">暂无数据</td></tr>';
                return;
            }
            
            items.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <input type="checkbox" class="row-checkbox" value="${item.id}" onchange="updateSelectAllState()">
                    </td>
                    <td>${item.title || ''}</td>
                    <td>${item.link || ''}</td>
                    <td>${item.author || ''}</td>
                    <td>${item.created_at || ''}</td>
                    <td>${item.updated_at || ''}</td>
                    <td>
                        <a href="javascript:void(0)" class="link-btn edit" onclick="editItem(${item.id}, '${item.title || ''}', '${item.link || ''}', '${item.author || ''}')">修改</a>
                        <a href="javascript:void(0)" class="link-btn delete" onclick="deleteItem(${item.id}, '${item.title || ''}')">删除</a>
                    </td>
                `;
                itemList.appendChild(tr);
            });
        }

        // 渲染分页
        function renderPagination(data) {
            // 添加空值检查
            if (!data) {
                console.error('分页数据为空');
                return;
            }

            try {
                // 更新总数显示
                document.getElementById('totalCount').textContent = data.total || 0;
                
                // 更新页码选择器
                const pageSize = document.getElementById('pageSize');
                pageSize.value = data.page_size || 10;
                
                // 计算总页数
                const totalPages = Math.ceil((data.total || 0) / (data.page_size || 10));
                
                // 生成页码
                const pageNumbers = document.getElementById('pageNumbers');
                pageNumbers.innerHTML = '';
                
                // 获取当前页码，确保是数字
                const currentPage = parseInt(data.page || 1);
                
                // 计算显示的页码范围
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, startPage + 4);
                
                // 调整起始页码，确保始终显示5个页码（如果有）
                if (endPage - startPage < 4) {
                    startPage = Math.max(1, endPage - 4);
                }
                
                // 添加页码
                for (let i = startPage; i <= endPage; i++) {
                    const span = document.createElement('span');
                    span.textContent = i;
                    if (i === currentPage) {
                        span.className = 'current';
                    }
                    span.onclick = () => loadItems(i);
                    pageNumbers.appendChild(span);
                }
                
                // 更新跳转输入框
                document.getElementById('pageInput').value = currentPage;
                
                // 更新按钮状态
                const prevBtn = document.querySelector('.page-btn:first-child');
                const nextBtn = document.querySelector('.page-btn:last-child');
                if (prevBtn) prevBtn.disabled = currentPage === 1;
                if (nextBtn) nextBtn.disabled = currentPage === totalPages;
            } catch (error) {
                console.error('渲染分页出错:', error);
            }
        }

        // 搜索功能
        function search() {
            const keyword = document.getElementById('searchInput').value;
            loadItems(1, keyword);
        }

        // 监听搜索框回车事件
        document.getElementById('searchInput').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                search();
            }
        });

        // 分页相关函数
        function changePageSize() {
            const newPageSize = parseInt(document.getElementById('pageSize').value);
            loadItems(1, null, newPageSize);
        }

        function prevPage() {
            if (currentPage > 1) {
                loadItems(currentPage - 1);
            }
        }

        function nextPage() {
            loadItems(currentPage + 1);
        }

        function jumpToPage() {
            const pageInput = document.getElementById('pageInput');
            const page = parseInt(pageInput.value);
            if (page > 0) {
                loadItems(page);
            } else {
                pageInput.value = currentPage;
            }
        }

        // 修改刷新功能
        async function refreshList() {
            try {
                // 添加加载状态
                const refreshBtn = document.querySelector('.btn.cyan');
                const originalText = refreshBtn.textContent;
                refreshBtn.textContent = '刷新中...';
                refreshBtn.disabled = true;

                // 重新加载数据
                await loadItems(currentPage, keyword, pageSize);

                // 恢复按钮状态
                refreshBtn.textContent = originalText;
                refreshBtn.disabled = false;

                
            } catch (error) {
                console.error('刷新失败:', error);
                
                
                // 恢复按钮状态
                const refreshBtn = document.querySelector('.btn.cyan');
                refreshBtn.textContent = '刷新';
                refreshBtn.disabled = false;
            }
        }
        
         // 调用后台控制器方法
         async function addItem() {
            try {   
                console.log("addItem===============")
                console.log("window.pywebview===============" + window.parent.parent.pywebview)
                console.log("window.pywebview.api===============" + window.parent.parent.pywebview.api)
                console.log(window.parent.parent.pywebview.api.plugin)
                const api = window.parent.parent.pywebview.api.plugin;
                if (api) {

                    // 获取输入值
                    const title = document.getElementById('title').value;
                    const link = document.getElementById('link').value;

                    // 通过 handle_api_call 调用注册的方法
                    const result = await api.handle_api_call({
                        plugin_name:pluginName,   // 插件名称（必填）
                        version:version,      // 插件版本（必填）
                        controller_name:'example_controller', // 控制器名称（必填）
                        method_name:'add_item',  // 方法名称（必填）
                        title:title,  // 标题（参数1）
                        link:link
                    }); // 链接（参数2）
                    console.log("result===============",result)
                    
                    if (result && result.success) {
                        MessageManager.success('添加成功', 3000);
                        hideAddDialog();
                        loadItems();
                    } else {
                        console.error('添加失败:', result.message);
                    }
                } else {
                    console.error('pywebview API 未找到');
                }
            } catch (error) {
                console.error('调用失败:', error);
            }
        }

        // 全选/取消全选
        function toggleSelectAll(checkbox) {
            const rowCheckboxes = document.querySelectorAll('.item-table .row-checkbox');
            rowCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }

        function showEditDialog(id, title, link, author) {
            document.getElementById('editDialog').style.display = 'block';
            document.getElementById('editTitle').value = title;
            document.getElementById('editLink').value = link;
            document.getElementById('editAuthor').value = author;
            document.getElementById('editId').value = id;
        }

        function hideEditDialog() {
            document.getElementById('editDialog').style.display = 'none';
        }

        async function editItem(id, title, link, author) {
            showEditDialog(id, title, link, author);
        }

        async function updateItem() {
            try {
                const api = window.parent.parent.pywebview.api.plugin;
                if (api) {
                    const id = document.getElementById('editId').value;
                    const title = document.getElementById('editTitle').value;
                    const link = document.getElementById('editLink').value;
                    const author = document.getElementById('editAuthor').value;

                    const result = await api.handle_api_call({
                        plugin_name: pluginName,
                        version: version,
                        controller_name: 'example_controller',
                        method_name: 'update_item',
                        id: id,
                        title: title,
                        link: link,
                        author: author
                    });

                    if (result && result.success) {
                        MessageManager.success(result.data);
                        hideEditDialog();
                        loadItems();
                    } else {
                        MessageManager.error(result.data);
                    }
                }
            } catch (error) {
                console.error('修改失败:', error);
                MessageManager.error('修改失败', 3000);
            }
        }

        async function deleteItem(id, title) {


            const result = await Message.confirm({
                title: '删除确认',
                content: `确定要删除 ${title} 吗？`,
                type: MessageManager.types.WARNING,
                confirmText: '确定',
                cancelText: '取消'
            });


            if (!result){
                return;
            }



           
                try {
                    const api = window.parent.parent.pywebview.api.plugin;
                    const result = await api.handle_api_call({
                        plugin_name: pluginName,
                        version: version,
                        controller_name: 'example_controller',
                        method_name: 'delete_item',
                        id: id
                    });

                    if (result && result.success) {
                        MessageManager.success(result.data);
                        loadItems();
                    } else {
                        MessageManager.error(result.data || '删除失败');
                    }
                } catch (error) {
                    console.error('删除失败:', error);
                    MessageManager.error('删除失败');
                }
            
        }

        // 修改初始化加载的部分
        function waitForPywebviewAndLoadItems() {
            if (window.parent && window.parent.parent && window.parent.parent.pywebview && window.parent.parent.pywebview.api && window.parent.parent.pywebview.api.plugin) {
                console.log('pywebview API 已准备就绪（轮询检测）');
                // 初始化加载第一页数据
                loadItems(1, '', 10); // 传入默认参数：第1页，空关键字，每页10条
            } else {
                setTimeout(waitForPywebviewAndLoadItems, 300);
            }
        }

        // 确保在 DOM 加载完成后执行初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM加载完成，开始等待pywebview初始化...');
            waitForPywebviewAndLoadItems();
        });

        // 添加批量删除方法
        async function batchDelete() {
            // 获取选中的复选框
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedIds.length === 0) {
                MessageManager.warning('请选择要删除的项目');
                return;
            }

            // 显示确认对话框
            const result = await Message.confirm({
                title: '批量删除确认',
                content: `确定要删除选中的 ${selectedIds.length} 项吗？`,
                type: MessageManager.types.WARNING,
                confirmText: '确定',
                cancelText: '取消'
            });

            if (!result) {
                return;
            }

            try {
                const api = window.parent.parent.pywebview.api.plugin;
                const result = await api.handle_api_call({
                    plugin_name: pluginName,
                    version: version,
                    controller_name: 'example_controller',
                    method_name: 'batch_delete_items',
                    ids: selectedIds
                });

                if (result && result.success) {
                    MessageManager.success(result.data);
                    // 重置全选框
                    document.getElementById('selectAll').checked = false;
                    // 重新加载数据
                    loadItems(currentPage, keyword, pageSize);
                } else {
                    MessageManager.error(result.data || '批量删除失败');
                }
            } catch (error) {
                console.error('批量删除失败:', error);
                MessageManager.error('批量删除失败');
            }
        }

        // 添加行选择框变化事件监听，用于更新全选框状态
        function updateSelectAllState() {
            const allCheckboxes = document.querySelectorAll('.row-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            const selectAllCheckbox = document.getElementById('selectAll');
            
            if (allCheckboxes.length > 0) {
                selectAllCheckbox.checked = allCheckboxes.length === checkedCheckboxes.length;
            }
        }

        // 加载采集账号列表
        async function loadCollectAccounts() {
            try {
                const api = window.parent.parent.pywebview.api.plugin;
                const result = await api.handle_api_call({
                    plugin_name: pluginName,
                    version: version,
                    controller_name: 'accountmanage_controller',
                    method_name: 'get_accounts'
                });

                if (result && result.success && result.data) {
                    const accountSelect = document.getElementById('collectAccount');
                    accountSelect.innerHTML = '<option value="">请选择采集账号</option>';
                    
                    result.data.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.id;
                        option.textContent = `${account.platform_name} - ${account.remark}（${account.username}）`;
                        accountSelect.appendChild(option);
                    });
                } else {
                    console.error('加载账号列表失败');
                    MessageManager.error('加载账号列表失败');
                }
            } catch (error) {
                console.error('加载账号列表失败:', error);
                MessageManager.error('加载账号列表失败');
            }
        }

        // 修改显示采集弹窗函数
        function showCollectDialog() {
            document.getElementById('collectDialog').style.display = 'block';
            document.getElementById('keyword').value = ''; // 清空关键词输入框
            document.getElementById('collectAccount').value = ''; // 清空账号选择
            loadCollectAccounts(); // 加载账号列表
        }

        // 隐藏采集弹窗
        function hideCollectDialog() {
            document.getElementById('collectDialog').style.display = 'none';
        }

        // 采集链接
        async function collectLinks() {
            try {
                const keyword = document.getElementById('keyword').value.trim();
                const accountId = document.getElementById('collectAccount').value;
                
                if (!keyword) {
                    MessageManager.warning('请输入关键词');
                    return;
                }

                if (!accountId) {
                    MessageManager.warning('请选择采集账号');
                    return;
                }

                // 添加按钮加载状态
                const collectBtn = document.querySelector('#collectDialog .btn.blue');
                const originalText = collectBtn.textContent;
                collectBtn.textContent = '采集中...';
                collectBtn.disabled = true;

                const api = window.parent.parent.pywebview.api.plugin;
                const result = await api.handle_api_call({
                    plugin_name: pluginName,
                    version: version,
                    controller_name: 'example_controller',
                    method_name: 'collect_links',
                    keyword: keyword,
                    account_id: accountId,
                    need_control_window: true
                });

                if (result && result.success) {
                    MessageManager.success('采集任务已开始');
                    hideCollectDialog();
                    loadItems(); // 刷新列表
                } else {
                    MessageManager.error(result.data || '采集失败');
                }
            } catch (error) {
                console.error('采集失败:', error);
                MessageManager.error('采集失败');
            } finally {
                // 恢复按钮状态
                const collectBtn = document.querySelector('#collectDialog .btn.blue');
                collectBtn.textContent = '确定';
                collectBtn.disabled = false;
            }
        }

    </script>
    
</body>
</html>